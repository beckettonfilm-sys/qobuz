<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qobuz – Album Browser</title>
<style>
/* --- Layout / header --- */
body {
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  margin:0;
  padding:0;
}
header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#1e1e1e;
  color:white;
  padding:10px 16px;
  gap:12px;
}
.nav-links {
  display:flex;
  gap:14px;
  align-items:center;
}
.nav-item {
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  color:white;
  font-weight:bold;
  transition: color .2s;
  font-size:0.95rem;
}
.nav-item .count { font-weight:normal; font-size:.8rem; color:#bbb; margin-left:6px; }
.nav-item .circle { width:10px; height:10px; border-radius:50%; border:2px solid #4CAF50; }
.nav-item.active .circle { background:#4CAF50; }

.header-controls {
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.header-controls button, .header-controls select, .header-controls input[type="date"] {
  background:#4CAF50;
  color:#fff;
  border-radius:5px;
  padding:6px 10px;
  border:none;
  font-weight:bold;
  cursor:pointer;
  font-size:.85rem;
}
.header-controls button { background:#1976D2; }
.header-controls select, .header-controls input[type="date"] { background:#2e7d32; padding:6px; }

/* folder control small buttons */
.folder-controls { display:flex; gap:6px; align-items:center; margin-left:6px; }
.folder-controls button { padding:6px 8px; font-weight:bold; border-radius:5px; border:none; cursor:pointer; background:#388E3C; color:white; }
.folder-controls button.delete { background:#D32F2F; }
.folder-controls button.export { background:#1976D2; }
.folder-controls button.edit { background:#F57C00; }

/* label filter panel */
#label-filter-panel {
  position:absolute;
  top:56px;
  right:20px;
  background:#fff;
  color:#000;
  padding:10px;
  border-radius:6px;
  box-shadow:0 8px 24px rgba(0,0,0,0.15);
  max-height:320px;
  overflow:auto;
  display:none;
  z-index:40;
}

/* main grid */
main { padding:18px; }
.albums-container {
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap:15px;
}

.album-card {
  background: #fff;
  border-radius: 10px;
  border-width: 3px;
  border-style: solid;
  border-color: var(--card-border-color, rgba(200,0,0,0.25));
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  font-size: .9rem;
  text-decoration: none;
  color: inherit;
  position: relative;
  transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease, border-width .25s ease;
}

.album-card:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  border-color: var(--card-hover-color, rgba(200,0,0,1));
  border-width: 8px;
}

/* card internals */
.album-cover { width:100%; display:block; min-height:120px; object-fit:cover; background:#ddd; }
.album-info { padding:8px; display:flex; flex-direction:column; gap:4px; flex-grow:1; }
.album-title { font-weight:bold; font-size:.85rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:flex; align-items:center; gap:8px; }
.album-artist { font-size:.75rem; color:#555; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.album-meta { font-size:.72rem; color:#777; }

.album-label-icon {
  position:absolute;
  bottom:6px;
  right:6px;
  width:56px;
  height:28px;
  object-fit:contain;
  pointer-events:auto;
  cursor:pointer;
  opacity:0.95;
  background:transparent;
  border-radius:3px;
}

.album-cover.grayscale { filter:grayscale(100%); transition:filter .25s ease; }
.album-card:hover .album-cover.grayscale { filter:grayscale(0%); }

.nav-item { transition: color .25s ease; }

.pagination { margin-top:18px; display:flex; justify-content:center; gap:15px; }
.pagination button { padding:8px 12px; border-radius:6px; border:none; background:#2196F3; color:white; cursor:pointer; font-weight:bold; }
.pagination button:disabled { background:#aaa; cursor:not-allowed; }

.stream-letter { font-weight:700; margin-right:6px; }

/* folder dot near title */
.folder-dot {
  width:0.8em;
  height:0.8em;
  border-radius:50%;
  display:inline-block;
  flex: 0 0 auto;
}

/* default colors applied dynamically; we keep placeholder */
.folder-dot.green { background:#2e7d32; }
.folder-dot.yellow { background:#b58900; }

/* small responsive tweaks */
@media (max-width:1200px) {
  .albums-container { grid-template-columns: repeat(4,1fr); }
}
@media (max-width:800px) {
  header { flex-wrap:wrap; gap:8px; }
  .albums-container { grid-template-columns: repeat(2,1fr); }
}

/* hidden file input */
#realFileInput { display:none; }

/* tooltip for folder options in select (some browsers won't show custom tooltip, but HTML title is set on option) */
</style>
</head>
<body class="cat-A">

<header>
  <div class="nav-links" id="navLinks">
    <div class="nav-item active" data-page="DB"><div class="circle"></div><span class="nav-text">MUSIC</span> <span class="count" id="countDB">(0)</span></div>
    <div class="nav-item" data-page="NR"><div class="circle"></div><span class="nav-text">NEWS</span> <span class="count" id="countNR">(0)</span></div>
    <div class="nav-item" data-page="FV"><div class="circle"></div><span class="nav-text">FAVORITE</span> <span class="count" id="countFV">(0)</span></div>
    <div class="nav-item" data-page="CS"><div class="circle"></div><span class="nav-text">SOON</span> <span class="count" id="countCS">(0)</span></div>
  </div>

  <div class="header-controls">
    <button id="updateBtn">AKTUALIZUJ</button>

    <!-- single TXT button (replaces DANE.TXT + Wybierz plik + filename) -->
    <input id="realFileInput" type="file" accept=".txt" />
    <button id="txtBtn">TXT</button>

    <div style="display:flex;align-items:center;">
      <select id="folderSelect" title="Wybierz folder (wpływa na FAVORITE)">
        <option value="__all__">wszystkie</option>
      </select>
      <div class="folder-controls" style="margin-left:6px;">
        <button id="newFolderBtn">+</button>
        <button id="editFolderBtn" class="edit">E</button>
        <button id="deleteFolderBtn" class="delete">-</button>
        <button id="exportFolderBtn" class="export">⇩</button>
      </div>
    </div>

    <input type="date" id="dateFrom" title="Data od" />
    <input type="date" id="dateTo" title="Data do" />

    <button id="labelFilterBtn">LABEL</button>
  </div>
</header>

<div id="label-filter-panel"></div>

<main>
  <div class="albums-container" id="albumsContainer"></div>

  <div class="pagination">
    <button id="prevBtn" disabled>Poprzedni</button>
    <button id="nextBtn" disabled>Następny</button>
  </div>
</main>

<script>
/* ======= Elementy DOM ======= */
const albumsContainer = document.getElementById('albumsContainer');
const realFileInput = document.getElementById('realFileInput');
const txtBtn = document.getElementById('txtBtn');
const updateBtn = document.getElementById('updateBtn');
const folderSelect = document.getElementById('folderSelect');
const dateFromInput = document.getElementById('dateFrom');
const dateToInput = document.getElementById('dateTo');
const labelFilterBtn = document.getElementById('labelFilterBtn');
const labelFilterPanel = document.getElementById('label-filter-panel');
const newFolderBtn = document.getElementById('newFolderBtn');
const deleteFolderBtn = document.getElementById('deleteFolderBtn');
const exportFolderBtn = document.getElementById('exportFolderBtn');
const editFolderBtn = document.getElementById('editFolderBtn');

const navItems = Array.from(document.querySelectorAll('.nav-item'));
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

let records = [];
let foldersList = new Set(['brak']);
let selectedLabels = new Set();
let hierarchy = [
"01A - ECM New Series","02A - Deutsche Grammophon (DG)","03A - Chandos","04A - Sony Classical",
"05A - Decca Music Group Ltd.","06A - Harmonia mundi","07A - Alpha Classics","08A - PENTATONE",
"09A - Channel Classics","10B - Hyperion","11B - BIS","12B - Warner Classics / Erato",
"13B - Delphian Records","14B - Lawo Classics","15B - Naxos","16B - Signum Records",
"17B - LSO Live","18B - Berlin Classics","19C - Aparté","20C - Orchid Classics",
"21C - Fuga Libera","22C - Ondine","23C - Evidence Classics","24C - Navona","25C - Ricercar",
"26C - Arcana","27C - Nonesuch","28C - Linn Records","29C - AVIE Records","30C - Naive",
"31C - Rubicon","32C - Mirare","33C - CPO","34C - Brilliant Classics","35C - Capriccio",
"36C - BR-Klassik","37C - Resonus Classics","38C - Onyx Classics","39C - First Hand Records",
"40C - Piano Classics","41C - Hänssler CLASSIC","42C - Grand Piano","43C - Bright Shiny Things"
];
const labelMap = {};
hierarchy.forEach(l=>{
  const [code,name]=l.split(" - ");
  labelMap[name.trim()]=code;
});

const albumsPerPage = 12;
let currentCategory = 'DB';
let currentPage = 0;
let categorized = { DB:[], NR:[], FV:[], CS:[] };

/* ======= Parsowanie linii ======= */
function parseLine(line) {
  const parts = line.split('-').map(p=>p.trim());
  const rec = { stream:'Q', selector:'N', folder:'brak', label:'', link:'', picture:'', artist:'', title:'', duration:0, heard:0, release_date:0, origSelector:'N'};
  parts.forEach(p=>{
    const [k,...rest] = p.split(':');
    const key = k && k.trim().toUpperCase();
    const val = rest.join(':').trim();
    if(!key) return;
    if(key==='STREAM') rec.stream = val;
    if(key==='SETECTOR') { rec.selector = val; rec.origSelector=val; }
    if(key==='FOLDER') rec.folder = val || 'brak';
    if(key==='LABEL') rec.label = val;
    if(key==='LINK') rec.link = val;
    if(key==='PICTURE') rec.picture = val;
    if(key==='ARTIST') rec.artist = val;
    if(key==='TITLE') rec.title = val;
    if(key==='DURATION') rec.duration = parseInt(val) || 0;
    if(key==='HEARD') rec.heard = parseInt(val) || 0;
    if(key==='RELEASE_DATE') rec.release_date = parseInt(val) || 0;
  });
  return rec;
}

/* ======= Wczytywanie pliku (TXT button) ======= */
txtBtn.addEventListener('click', ()=> realFileInput.click());
realFileInput.addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = evt=>{
    records = evt.target.result.split(/\r?\n/).filter(l=>l.trim()).map(parseLine);
    // rebuild folders set from records
    foldersList = new Set(['brak']);
    records.forEach(r=>{ if(r.folder && r.folder.trim()) foldersList.add(r.folder); });
    rebuildFolderSelect();
    buildLabelFilterPanel();
    processAndRender();
    alert(`✅ Załadowano ${records.length} rekordów`);
    // clear input so selecting same file again will trigger change
    realFileInput.value = '';
  };
  r.readAsText(f);
});

/* ======= Folder counts and rebuild ======= */
function getFolderCounts(){
  const map = {};
  foldersList.forEach(f => map[f] = 0);
  records.forEach(r => {
    const fld = (r.folder && r.folder.trim()) ? r.folder : 'brak';
    if(!(fld in map)) map[fld]=0;
    map[fld]++;
  });
  return map;
}

/* truncate helper: show up to n chars, add ellipsis if longer */
function truncateName(name, n){
  if(!name) return '';
  if(name.length <= n) return name;
  return name.slice(0,n) + '…';
}

/* rebuild folder select while preserving selection if possible */
function rebuildFolderSelect(){
  const prev = folderSelect.value;
  const counts = getFolderCounts();
  folderSelect.innerHTML = '';
  const allOpt = document.createElement('option');
  allOpt.value='__all__';
  allOpt.textContent = 'wszystkie';
  allOpt.title = 'Pokaż wszystkie';
  folderSelect.appendChild(allOpt);

  // build sorted folder list: show 'brak' after 'wszystkie', then alphabetical (locale pl)
  const others = Array.from(foldersList).filter(f=>f!=='brak').sort((a,b)=>a.localeCompare(b,'pl'));
  const full = ['brak', ...others];

  full.forEach(fld=>{
    const opt = document.createElement('option');
    opt.value = fld;
    const disp = fld === 'brak' ? 'brak' : (fld);
    const truncated = (disp.length > 15) ? truncateName(disp, 15) : disp;
    const count = counts[fld] || 0;
    opt.textContent = `${truncated} (${count})`;
    opt.title = fld; // tooltip shows full name
    folderSelect.appendChild(opt);
  });

  // preserve selection if possible
  if(prev && Array.from(folderSelect.options).some(o=>o.value===prev)){
    folderSelect.value = prev;
  } else {
    // if previous not present, keep __all__
    folderSelect.value = '__all__';
  }
}

/* ======= Label filter panel ======= */
function buildLabelFilterPanel(){
  labelFilterPanel.innerHTML = '<strong>Wybierz wytwórnie:</strong><div style="height:8px"></div>';
  hierarchy.forEach(l=>{
    const [,name] = l.split(' - ');
    const id = 'lblchk_'+name.replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
    const div = document.createElement('div');
    div.style.marginBottom='6px';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=name; cb.checked=true;
    cb.addEventListener('change', ()=>{
      if(cb.checked) selectedLabels.add(name); else selectedLabels.delete(name);
      processAndRender();
    });
    const lbl = document.createElement('label'); lbl.htmlFor=id; lbl.style.marginLeft='6px'; lbl.textContent=name;
    div.appendChild(cb); div.appendChild(lbl);
    labelFilterPanel.appendChild(div);
    selectedLabels.add(name);
  });
  const tools = document.createElement('div'); tools.style.marginTop='8px';
  const allBtn = document.createElement('button'); allBtn.textContent='Wszystkie'; allBtn.style.marginRight='6px';
  const noneBtn = document.createElement('button'); noneBtn.textContent='Brak';
  allBtn.onclick = ()=>{ Array.from(labelFilterPanel.querySelectorAll('input[type=checkbox]')).forEach(ch=>{ ch.checked=true; selectedLabels.add(ch.value); }); processAndRender(); };
  noneBtn.onclick = ()=>{ Array.from(labelFilterPanel.querySelectorAll('input[type=checkbox]')).forEach(ch=>{ ch.checked=false; selectedLabels.delete(ch.value); }); processAndRender(); };
  tools.appendChild(allBtn); tools.appendChild(noneBtn);
  labelFilterPanel.appendChild(tools);
}

labelFilterBtn.addEventListener('click', ()=>{
  labelFilterPanel.style.display = labelFilterPanel.style.display === 'block' ? 'none' : 'block';
});
document.addEventListener('click', (e)=>{
  if(!labelFilterPanel.contains(e.target) && e.target!==labelFilterBtn) labelFilterPanel.style.display='none';
});

/* ======= Core processing and rendering ======= */
function processAndRender(){
  categorized = { DB:[], NR:[], FV:[], CS:[] };
  const now = new Date();
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime()/1000;
  const dateFrom = dateFromInput.value ? new Date(dateFromInput.value).getTime()/1000 : null;
  const dateTo = dateToInput.value ? (new Date(dateToInput.value).getTime()/1000 + 86399) : null;

  records.forEach(rec=>{
    // filtr etykiet
    if(selectedLabels.size && !selectedLabels.has(rec.label)) return;
    // filtr dat
    if(dateFrom && rec.release_date && rec.release_date<dateFrom) return;
    if(dateTo && rec.release_date && rec.release_date>dateTo) return;

    const alb = rec; // używamy oryginału, bez kopiowania
    alb._durationNum = rec.duration;

    // Coming Soon: albumy < 30 minut
    if(alb._durationNum < 1800) categorized.CS.push(alb);

    // New Releases: ostatnie 7 dni, nie oznaczone jako F
    const diffDays = alb.release_date ? Math.floor((todayStart - alb.release_date)/86400) : 9999;
    if(alb.release_date && diffDays >= 0 && diffDays <= 6 && alb.selector!=='F') categorized.NR.push(alb);

    // Favorite (selector F)
    if(alb.selector==='F') categorized.FV.push(alb);

    // DB (wszystkie)
    categorized.DB.push(alb);
    // collect folders
    if(alb.folder && alb.folder.trim()) foldersList.add(alb.folder);
  });

  // Wykluczamy NR i CS z DB
  const excludeIds = new Set();
  categorized.NR.forEach(a=>excludeIds.add(a.link));
  categorized.CS.forEach(a=>excludeIds.add(a.link));
  categorized.DB = categorized.DB.filter(a=>!excludeIds.has(a.link));

  const getCodeNum = (album)=>{
    const code = labelMap[album.label];
    return code ? parseInt(code) : 999;
  };

  ['DB','NR','FV','CS'].forEach(cat=>{
    categorized[cat].sort((a,b)=>getCodeNum(a)-getCodeNum(b));
  });

  document.getElementById('countDB').textContent = `(${categorized.DB.length})`;
  document.getElementById('countNR').textContent = `(${categorized.NR.length})`;
  document.getElementById('countFV').textContent = `(${categorized.FV.length})`;
  document.getElementById('countCS').textContent = `(${categorized.CS.length})`;

  rebuildFolderSelect();
  renderCategory(currentCategory);
}

function renderCategory(cat){
  currentCategory = cat; currentPage=0;
  document.body.classList.remove('cat-A','cat-B','cat-C','cat-D');
  if(cat==='NR') document.body.classList.add('cat-A');
  else if(cat==='FV') document.body.classList.add('cat-B');
  else if(cat==='DB') document.body.classList.add('cat-C');
  else if(cat==='CS') document.body.classList.add('cat-D');
  updateNavActive(cat);
  renderAlbumsPage();
}

function updateNavActive(cat){
  navItems.forEach(it=>{
    it.classList.remove('active');
    if(it.dataset.page===cat) it.classList.add('active');
  });
}

function renderAlbumsPage(){
  let list = categorized[currentCategory] || [];

  // --- IMPORTANT: show folder contents on FAVORITE when a specific folder is selected ---
  if(currentCategory==='FV' && folderSelect.value!=='__all__') {
    const fld = folderSelect.value;
    list = records.filter(r => (r.folder || 'brak') === fld);
  } else {
    if(currentCategory==='FV' && folderSelect.value==='__all__') {
      list = categorized.FV || [];
    }
  }

  const total = list.length;
  const start = currentPage * albumsPerPage;
  const end = start + albumsPerPage;
  const pageItems = list.slice(start, end);

  albumsContainer.innerHTML = '';

  pageItems.forEach(album=>{
    const a = document.createElement('a');
    a.href = album.link || '#';
    a.target = '_blank';
    a.className = 'album-card';
    a.title = `${album.title} — ${album.artist}`;

    const img = document.createElement('img');
    img.className = 'album-cover';
    img.src = album.picture || '';
    if(album.selector==='X') img.classList.add('grayscale');

    const info = document.createElement('div');
    info.className = 'album-info';
    const t = document.createElement('div'); t.className='album-title';

    // folder dot if album is in a folder (not 'brak'); color depends on folder name starting with LIKE:
    if(album.folder && album.folder !== 'brak') {
      const dot = document.createElement('span'); dot.className='folder-dot';
      if((album.folder||'').startsWith('LIKE:')) dot.classList.add('yellow'); else dot.classList.add('green');
      t.appendChild(dot);
    }

    const titleText = document.createElement('span');
    titleText.style.minWidth='0';
    titleText.textContent = album.title;
    t.appendChild(titleText);

    const ar = document.createElement('div'); ar.className='album-artist'; ar.textContent = album.artist;
    const m = document.createElement('div'); m.className='album-meta';
    const streamSpan = document.createElement('span'); streamSpan.className='stream-letter'; streamSpan.textContent = album.stream;
    const d = new Date(album.release_date*1000);
    const dateStr = album.release_date?`${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`:'brak';
    const dur = formatDuration(album.duration);
    const metaTxt = `(${album.heard}) • ${dateStr} • ${dur}`;
    m.appendChild(streamSpan); m.appendChild(document.createTextNode(' '+metaTxt));
    info.appendChild(t); info.appendChild(ar); info.appendChild(m);

    const code = labelMap[album.label] || '00A';
    const icon = document.createElement('img');
    icon.className = 'album-label-icon';
    icon.src = `${code}.svg`;
    icon.alt = album.label;
    icon.title = album.label;
    icon.addEventListener('click', ev=>{
      ev.preventDefault(); ev.stopPropagation();
      cycleSelector(album,img,a);
    });

    a.addEventListener('mouseenter', ()=>{ if(album.selector==='X') img.classList.remove('grayscale'); });
    a.addEventListener('mouseleave', ()=>{ if(album.selector==='X') img.classList.add('grayscale'); });

    applySelectorColorToCard(a, album.selector);

    // folder-assign via right-click + CTRL on the card
    a.addEventListener('contextmenu', ev=>{
      // If CTRL pressed and a specific folder selected -> assign album to that folder
      if(ev.ctrlKey && folderSelect.value && folderSelect.value !== '__all__') {
        ev.preventDefault();
        const targetFolder = folderSelect.value;
        const prevFolder = album.folder || 'brak';
        if(prevFolder === targetFolder) {
          alert(`Album już znajduje się w folderze: ${targetFolder}`);
          return;
        }
        // assign
        album.folder = targetFolder;
        const rec = records.find(r => r.link === album.link);
        if(rec) rec.folder = targetFolder;
        // ensure folder exists in set
        foldersList.add(targetFolder);
        // update counts and DOM but preserve currently selected folder
        rebuildFolderSelect();
        renderAlbumsPage();
        // do NOT change selected folder; keep it active so user can add more albums
        alert(`✅ Dodano album do folderu: ${targetFolder}`);
        return;
      }
      // otherwise, do not preventDefault here — let other handlers handle contextmenu on child elements
    });

    // SHIFT + click: remove album from its folder (if assigned)
    a.addEventListener('click', ev=>{
      // only act on left click with shift (not when ctrl or meta)
      if(ev.shiftKey && !ev.ctrlKey && !ev.metaKey){
        ev.preventDefault();
        if(album.folder && album.folder !== 'brak'){
          const prev = album.folder;
          album.folder = 'brak';
          const rec = records.find(r => r.link === album.link);
          if(rec) rec.folder = 'brak';
          rebuildFolderSelect();
          renderAlbumsPage();
          alert(`✅ Usunięto album z folderu: ${prev}`);
        } else {
          // if album wasn't in a folder, do nothing (or could inform)
          // no action
        }
      }
    });

    // HEARD adjust with numpad + right click on album-meta (existing behaviour)
    m.addEventListener('contextmenu', ev=>{
      ev.preventDefault();
      const numpad = window.numpadSign || 1;
      if(window.numpadKey==='+'||window.numpadKey==='-'){
        if(window.numpadKey==='+') album.heard += numpad;
        else album.heard = Math.max(0, album.heard - numpad);
        renderAlbumsPage();
      }
    });

    a.appendChild(img); a.appendChild(info); a.appendChild(icon);
    albumsContainer.appendChild(a);
  });

  prevBtn.disabled = currentPage === 0;
  nextBtn.disabled = (end >= list.length);
}

/* ======= Pagination & Nav ======= */
prevBtn.addEventListener('click', ()=>{ if(currentPage>0){ currentPage--; renderAlbumsPage(); }});
nextBtn.addEventListener('click', ()=>{
  let list=categorized[currentCategory]||[];
  if(currentCategory==='FV' && folderSelect.value!=='__all__') list=list.filter(a=> (a.folder || 'brak')===folderSelect.value);
  if((currentPage+1)*albumsPerPage<list.length){ currentPage++; renderAlbumsPage(); }
});

navItems.forEach(it=>{ it.addEventListener('click', ()=>{ renderCategory(it.dataset.page); }); });

/* ======= Selector cycling ======= */
function cycleSelector(album, imgEl, cardEl){
  const current = album.selector || 'N';
  const orig = album.origSelector || 'N';
  let next;
  if(current === orig) next = 'L';
  else if(current === 'L') next = 'X';
  else next = orig;

  album.selector = next;

  // Synchronizacja z oryginalnym rekordem w 'records'
  const rec = records.find(r => r.link === album.link);
  if(rec) rec.selector = next;

  applySelectorColorToCard(cardEl, next);
  if(next === 'X') imgEl.classList.add('grayscale');
  else imgEl.classList.remove('grayscale');
  renderAlbumsPage();
}

/* ======= Card color styling ======= */
function applySelectorColorToCard(cardEl,selector){
  let baseColor, hoverColor;
  if(selector==='N'){ baseColor='rgba(0,123,255,0.4)'; hoverColor='rgba(0,123,255,1)'; }
  else if(selector==='L'||selector==='F'){ baseColor='rgba(40,167,69,0.4)'; hoverColor='rgba(40,167,69,1)'; }
  else if(selector==='X'){ baseColor='rgba(108,117,125,0.4)'; hoverColor='rgba(108,117,125,1)'; }
  else{ baseColor='rgba(200,200,200,0.25)'; hoverColor='rgba(200,200,200,1)'; }
  cardEl.style.setProperty('--card-border-color',baseColor);
  cardEl.style.setProperty('--card-hover-color',hoverColor);
  cardEl.style.borderWidth='3px'; cardEl.style.borderStyle='solid';
}

/* ======= Helpers ======= */
function formatDuration(seconds){
  seconds=Number(seconds)||0;
  const h=Math.floor(seconds/3600), m=Math.floor((seconds%3600)/60), s=seconds%60;
  if(h>0) return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  return `${m}:${s.toString().padStart(2,'0')}`;
}

/* ======= Export updated data (AKTUALIZUJ) ======= */
updateBtn.addEventListener('click', ()=>{
  if(records.length===0){ alert('Brak wczytanego pliku DANE.TXT'); return; }
  const lines = records.map(r=>{
    const parts = [
      `STREAM:${r.stream}`,
      `SETECTOR:${r.selector}`,
      `FOLDER:${r.folder}`,
      `LABEL:${r.label}`,
      `LINK:${r.link}`,
      `PICTURE:${r.picture}`,
      `ARTIST:${r.artist}`,
      `TITLE:${r.title}`,
      `DURATION:${r.duration}`,
      `HEARD:${r.heard}`,
      `RELEASE_DATE:${r.release_date}`
    ];
    return parts.join('-');
  });
  const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='DANE_UPDATED.TXT'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  alert('✅ Przygotowano do pobrania zaktualizowany plik DANE_UPDATED.TXT');
});

/* ======= Folder creation / validation / edit / delete / export ======= */

function isValidFolderName(name){
  if(typeof name !== 'string') return false;
  name = name.trim();
  if(name.length === 0) return false;
  if(name.length > 50) return false;
  if(/\s/.test(name)) return false; // no spaces allowed
  return true;
}

newFolderBtn.addEventListener('click', ()=>{
  if(foldersList.size >= 100){
    alert('Osiągnięto limit 100 folderów — nie można utworzyć nowego folderu.');
    return;
  }
  const raw = prompt('Podaj nazwę nowego folderu (max 50 znaków, bez spacji):');
  if(raw === null) return; // cancel
  const name = raw.trim();
  if(!isValidFolderName(name)){
    alert('Nieprawidłowa nazwa folderu. Zasady: brak spacji, max 50 znaków. Możliwe polskie litery.');
    return;
  }
  if(foldersList.has(name)){
    alert('Folder o takiej nazwie już istnieje.');
    return;
  }
  foldersList.add(name);
  rebuildFolderSelect();
  folderSelect.value = name;
  alert(`Utworzono folder: ${name}`);
  if(currentCategory==='FV') renderAlbumsPage();
});

editFolderBtn.addEventListener('click', ()=>{
  const selected = folderSelect.value;
  if(!selected || selected === '__all__'){
    alert('Wybierz najpierw konkretny folder do edycji.');
    return;
  }
  if(selected === 'brak'){
    alert('Nie można edytować folderu "brak".');
    return;
  }
  const raw = prompt('Nowa nazwa folderu (max 50 znaków, bez spacji):', selected);
  if(raw === null) return;
  const name = raw.trim();
  if(!isValidFolderName(name)){
    alert('Nieprawidłowa nazwa folderu. Zasady: brak spacji, max 50 znaków.');
    return;
  }
  if(name === selected) return; // no change
  if(foldersList.has(name)){
    alert('Folder o takiej nazwie już istnieje.');
    return;
  }
  // rename in set: remove old, add new
  foldersList.delete(selected);
  foldersList.add(name);
  // update records that had old name
  records.forEach(r=>{ if(r.folder === selected) r.folder = name; });
  rebuildFolderSelect();
  folderSelect.value = name;
  alert(`Zmieniono nazwę folderu: ${selected} → ${name}`);
  if(currentCategory==='FV') renderAlbumsPage();
});

deleteFolderBtn.addEventListener('click', ()=>{
  const selected = folderSelect.value;
  if(!selected || selected === '__all__'){
    alert('Wybierz najpierw konkretny folder, który chcesz usunąć.');
    return;
  }
  if(selected === 'brak'){
    alert('Nie można usunąć folderu "brak".');
    return;
  }
  const ok = confirm(`Usunąć folder "${selected}"? Wszystkie albumy w tym folderze zostaną przeniesione do "brak". Potwierdzasz?`);
  if(!ok) return;
  // remove folder from set
  foldersList.delete(selected);
  // update records that had this folder
  records.forEach(r=>{
    if(r.folder === selected) r.folder = 'brak';
  });
  rebuildFolderSelect();
  // keep selection as __all__ after removal
  folderSelect.value = '__all__';
  renderAlbumsPage();
  alert(`Usunięto folder: ${selected}`);
});

exportFolderBtn.addEventListener('click', ()=>{
  const selected = folderSelect.value;
  if(!selected || selected === '__all__'){
    alert('Wybierz najpierw konkretny folder do eksportu.');
    return;
  }
  const links = records.filter(r=> (r.folder || 'brak') === selected && r.link).map(r=>r.link);
  const content = links.join('\n');
  const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  // ensure filename safe
  const filename = `${selected}.txt`;
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  alert(`✅ Wyeksportowano ${links.length} linków do pliku ${filename}`);
});

/* ======= Date controls ======= */
dateFromInput.addEventListener('change', processAndRender);
dateToInput.addEventListener('change', processAndRender);

/* ======= Empty state ======= */
function showEmptyState(){
  albumsContainer.innerHTML = `<div style="grid-column:1/-1;padding:30px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);">Wczytaj plik TXT (przycisk TXT), aby rozpocząć pracę.<br>Format: STREAM:S-SETECTOR:N-FOLDER:F-LABEL:L-LINK:K-PICTURE:P-ARTIST:A-TITLE:T-DURATION:D-HEARD:H-RELEASE_DATE:R</div>`;
}
showEmptyState();

/* ======= Hover style injection ======= */
(function injectHoverStyle(){
  const css=document.createElement('style'); css.innerHTML=`.album-card:hover { border-color: var(--card-hover-color, rgba(200,0,0,0.85)); }`; document.head.appendChild(css);
})();

/* ======= Numpad handlers ======= */
window.numpadSign=1; window.numpadKey='';
window.addEventListener('keydown', e=>{
  if(e.code==='NumpadAdd') window.numpadKey='+';
  else if(e.code==='NumpadSubtract') window.numpadKey='-';
});
window.addEventListener('keyup', e=>{ window.numpadKey=''; });
window.addEventListener('keydown', e=>{
  if(e.code.startsWith('Numpad') && !isNaN(e.key)) window.numpadSign=parseInt(e.key);
});

/* ======= Initial folder select build ======= */
rebuildFolderSelect();
buildLabelFilterPanel();
renderCategory(currentCategory);

</script>
</body>
</html>
